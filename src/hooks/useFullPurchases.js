import { useState, useCallback } from 'react';
import { supabase } from '@/lib/customSupabaseClient';
import { toast } from '@/components/ui/use-toast';
import { useInventory } from '@/contexts/InventoryContext';
import { useAuth } from '@/contexts/UnifiedAuthContext';

export const useFullPurchases = () => {
  const [purchases, setPurchases] = useState([]);
  const [loading, setLoading] = useState(false);
  const { updateVariantStock, addExpense, refetchData } = useInventory();
  const { user } = useAuth();

  const addPurchase = useCallback(async (purchaseData) => {
    setLoading(true);
    try {
      // ุญุณุงุจ ุงูุชูููุฉ ุงูุฅุฌูุงููุฉ ุดุงููุฉ ุงูุดุญู ูุงูุชุญููู
      const itemsTotal = purchaseData.items.reduce((sum, item) => sum + (item.costPrice * item.quantity), 0);
      const totalAmount = itemsTotal + (purchaseData.shippingCost || 0) + (purchaseData.transferCost || 0);

      console.log('๐ ุจูุงูุงุช ุงููุงุชูุฑุฉ:', {
        supplier: purchaseData.supplier,
        itemsTotal,
        shippingCost: purchaseData.shippingCost || 0,
        transferCost: purchaseData.transferCost || 0,
        totalAmount,
        cashSourceId: purchaseData.cashSourceId
      });

      // ุฅุถุงูุฉ ูุงุชูุฑุฉ ุงูุดุฑุงุก
      const { data: newPurchase, error } = await supabase
        .from('purchases')
        .insert({
          supplier_name: purchaseData.supplier,
          supplier_contact: purchaseData.supplierContact || null,
          total_amount: totalAmount, // ุงููุจูุบ ุงูุฅุฌูุงูู ุดุงูู ูู ุดูุก
          paid_amount: totalAmount,
          shipping_cost: purchaseData.shippingCost || 0,
          transfer_cost: purchaseData.transferCost || 0,
          purchase_date: purchaseData.purchaseDate ? new Date(purchaseData.purchaseDate) : new Date(),
          cash_source_id: purchaseData.cashSourceId, // ูุตุฏุฑ ุงูููุฏ
          status: 'completed',
          items: purchaseData.items,
          created_by: user?.user_id
        })
        .select()
        .single();

      if (error) throw error;

      console.log('๐ ุชู ุฅูุดุงุก ุงููุงุชูุฑุฉ:', newPurchase);

      // ุฅุถุงูุฉ ุนูุงุตุฑ ุงููุงุชูุฑุฉ ูุฌุฏูู purchase_items
      const purchaseItemsPromises = purchaseData.items.map(item => 
        supabase.from('purchase_items').insert({
          purchase_id: newPurchase.id,
          product_id: item.productId,
          variant_id: item.variantId,
          quantity: item.quantity,
          unit_cost: item.costPrice,
          total_cost: item.costPrice * item.quantity
        })
      );
      
      await Promise.all(purchaseItemsPromises);
      console.log('๐ฆ ุชู ุฅุถุงูุฉ ุนูุงุตุฑ ุงููุงุชูุฑุฉ');

      // ุชุญุฏูุซ ุงููุฎุฒูู ููู ููุชุฌ
      for (const item of purchaseData.items) {
        try {
          console.log('๐ ุชุญุฏูุซ ูุฎุฒูู:', {
            sku: item.variantSku,
            quantity: item.quantity,
            costPrice: item.costPrice
          });
          
          // ุชุญุฏูุซ ุงููุฎุฒูู ูุจุงุดุฑุฉ ุจุฏูู ุฏูุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช
          const { data: variant, error: variantError } = await supabase
            .from('product_variants')
            .select('id, product_id')
            .eq('sku', item.variantSku)
            .single();

          if (variantError) {
            console.error(`โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุชุบูุฑ ${item.variantSku}:`, variantError);
            continue;
          }

          // ุชุญุฏูุซ ุงููุฎุฒูู ูุจุงุดุฑุฉ
          const { error: inventoryError } = await supabase
            .from('inventory')
            .upsert({
              product_id: variant.product_id,
              variant_id: variant.id,
              quantity: item.quantity
            }, {
              onConflict: 'product_id,variant_id',
              ignoreDuplicates: false
            });

          if (inventoryError) {
            console.error(`โ ุฎุทุฃ ูู ุชุญุฏูุซ ูุฎุฒูู ${item.variantSku}:`, inventoryError);
            throw new Error(`ูุดู ูู ุชุญุฏูุซ ูุฎุฒูู ${item.variantSku}: ${inventoryError.message}`);
          }
          
          console.log(`โ ุชู ุชุญุฏูุซ ูุฎุฒูู ${item.variantSku} ุจูุฌุงุญ`);
      }

      // ุฎุตู ุงููุจูุบ ูู ูุตุฏุฑ ุงูููุฏ
      if (purchaseData.cashSourceId && totalAmount > 0) {
        console.log('๐ฐ ุฎุตู ุงููุจูุบ ูู ูุตุฏุฑ ุงูููุฏ:', {
          cashSourceId: purchaseData.cashSourceId,
          amount: totalAmount
        });

        // ุชุญุฏูุซ ุฑุตูุฏ ุงูููุฏ ูุจุงุดุฑุฉ ุจุฏูู ุฏูุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        const { data: currentSource, error: fetchError } = await supabase
          .from('cash_sources')
          .select('current_balance')
          .eq('id', purchaseData.cashSourceId)
          .single();

        if (!fetchError) {
          const newBalance = (currentSource.current_balance || 0) - totalAmount;
          
          // ุฅุถุงูุฉ ุญุฑูุฉ ููุฏูุฉ
          await supabase.from('cash_movements').insert({
            cash_source_id: purchaseData.cashSourceId,
            amount: totalAmount,
            movement_type: 'out',
            reference_type: 'purchase',
            reference_id: newPurchase.id,
            description: `ูุงุชูุฑุฉ ุดุฑุงุก ${newPurchase.purchase_number} - ${purchaseData.supplier}`,
            created_by: user?.user_id,
            balance_before: currentSource.current_balance,
            balance_after: newBalance
          });

          // ุชุญุฏูุซ ุฑุตูุฏ ุงููุตุฏุฑ
          await supabase
            .from('cash_sources')
            .update({ current_balance: newBalance })
            .eq('id', purchaseData.cashSourceId);

          console.log('โ ุชู ุฎุตู ุงููุจูุบ ูู ูุตุฏุฑ ุงูููุฏ ุจูุฌุงุญ');
        }
      }

      // ุฅุถุงูุฉ ุงููุตุงุฑูู
      // ุฅุถุงูุฉ ูุตุฑูู ุงูุดุฑุงุก (ุชูููุฉ ุงูููุชุฌุงุช)
      await addExpense({
        category: 'ูุดุชุฑูุงุช',
        expense_type: 'operational',
        description: `ุดุฑุงุก ุจุถุงุนุฉ - ูุงุชูุฑุฉ ${newPurchase.purchase_number} ูู ${purchaseData.supplier}`,
        amount: itemsTotal,
        vendor_name: purchaseData.supplier,
        receipt_number: newPurchase.purchase_number,
        status: 'approved'
      });
      console.log(`โ ุชู ุฅุถุงูุฉ ูุตุฑูู ุงูุดุฑุงุก: ${itemsTotal} ุฏ.ุน`);

      // ุฅุถุงูุฉ ูุตุฑูู ุงูุดุญู ุฅุฐุง ูุงู ููุฌูุฏ
      if (purchaseData.shippingCost && purchaseData.shippingCost > 0) {
        await addExpense({
          category: 'ุดุญู ูููู',
          expense_type: 'operational',
          description: `ุชูููุฉ ุดุญู ูุงุชูุฑุฉ ุดุฑุงุก ${newPurchase.purchase_number} - ${purchaseData.supplier}`,
          amount: purchaseData.shippingCost,
          vendor_name: purchaseData.supplier,
          receipt_number: newPurchase.purchase_number + '-SHIP',
          status: 'approved'
        });
        console.log(`โ ุชู ุฅุถุงูุฉ ูุตุฑูู ุงูุดุญู: ${purchaseData.shippingCost} ุฏ.ุน`);
      }

      // ุฅุถุงูุฉ ูุตุฑูู ุงูุชุญููู ุฅุฐุง ูุงู ููุฌูุฏ
      if (purchaseData.transferCost && purchaseData.transferCost > 0) {
        await addExpense({
          category: 'ุชูุงููู ุงูุชุญููู',
          expense_type: 'operational',
          description: `ุชูููุฉ ุชุญููู ูุงูู ูุงุชูุฑุฉ ุดุฑุงุก ${newPurchase.purchase_number} - ${purchaseData.supplier}`,
          amount: purchaseData.transferCost,
          vendor_name: purchaseData.supplier,
          receipt_number: newPurchase.purchase_number + '-TRANSFER',
          status: 'approved'
        });
        console.log(`โ ุชู ุฅุถุงูุฉ ูุตุฑูู ุงูุชุญููู: ${purchaseData.transferCost} ุฏ.ุน`);
      }

      // ุชุญุฏูุซ ูุงุฆูุฉ ุงููุดุชุฑูุงุช ููุฑุงู
      setPurchases(prev => [newPurchase, ...prev]);

      // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ููุชุฃูุฏ ูู ุงูุชุญุฏูุซ ุงููุงูู
      setTimeout(async () => {
        await refetchData();
        console.log('๐ ุชู ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุฅุถุงูุฉ ุงููุงุชูุฑุฉ');
      }, 500);

      console.log('โ ุชูุช ุฅุถุงูุฉ ุงููุงุชูุฑุฉ ุจูุฌุงุญ:', newPurchase);
      
      toast({ 
        title: 'ูุฌุญ', 
        description: `ุชูุช ุฅุถุงูุฉ ูุงุชูุฑุฉ ุงูุดุฑุงุก ุฑูู ${newPurchase.purchase_number} ุจูุฌุงุญ ูุชู ุชุญุฏูุซ ุงููุฎุฒูู ูุงููุญุงุณุจุฉ.`,
        variant: 'success'
      });

      return { success: true, purchase: newPurchase };
    } catch (error) {
      console.error("โ ุฎุทุฃ ูู ุฅุถุงูุฉ ูุงุชูุฑุฉ ุงูุดุฑุงุก:", error);
      toast({ 
        title: 'ุฎุทุฃ', 
        description: `ูุดู ุฅุถุงูุฉ ูุงุชูุฑุฉ ุงูุดุฑุงุก: ${error.message}`, 
        variant: 'destructive' 
      });
      return { success: false, error: error.message };
    } finally {
      setLoading(false);
    }
  }, [addExpense, refetchData, user]);

  const fetchPurchases = useCallback(async () => {
    setLoading(true);
    try {
      const { data, error } = await supabase
        .from('purchases')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) throw error;
      setPurchases(data || []);
    } catch (error) {
      console.error("ุฎุทุฃ ูู ุฌูุจ ุงููุดุชุฑูุงุช:", error);
      toast({ 
        title: 'ุฎุทุฃ', 
        description: 'ูุดู ูู ุฌูุจ ุจูุงูุงุช ุงููุดุชุฑูุงุช', 
        variant: 'destructive' 
      });
    } finally {
      setLoading(false);
    }
  }, []);

  const deletePurchase = useCallback(async (purchaseId) => {
    try {
      setLoading(true);
      
      console.log('๐๏ธ ุจุฏุก ุญุฐู ุงููุงุชูุฑุฉ:', purchaseId);
      
      // ุญุฐู ุงููุงุชูุฑุฉ ูุจุงุดุฑุฉ ุจุฏูู ุฏูุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุนูุฏุฉ
      const { error: deleteError } = await supabase
        .from('purchases')
        .delete()
        .eq('id', purchaseId);

      if (deleteError) {
        console.error('โ ุฎุทุฃ ูู ุญุฐู ุงููุงุชูุฑุฉ:', deleteError);
        throw new Error(`ูุดู ูู ุญุฐู ุงููุงุชูุฑุฉ: ${deleteError.message}`);
      }

      console.log('โ ุชู ุญุฐู ุงููุงุชูุฑุฉ ุจูุฌุงุญ');

      // ุชุญุฏูุซ ุงููุงุฆูุฉ ุงููุญููุฉ
      setPurchases(prev => prev.filter(p => p.id !== purchaseId));
      
      // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ูุถูุงู ุงูุชุญุฏูุซ ุงููุงูู
      if (refetchData) {
        setTimeout(async () => {
          await refetchData();
          console.log('๐ ุชู ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุงูุญุฐู');
        }, 500);
      }
      
      toast({ 
        title: 'ุชู ุงูุญุฐู ุจูุฌุงุญ', 
        description: 'ุชู ุญุฐู ุงููุงุชูุฑุฉ ุจูุฌุงุญ',
        variant: 'success'
      });
      
      return { success: true, purchase: { id: purchaseId } };
    } catch (error) {
      console.error("โ ุฎุทุฃ ูู ุญุฐู ูุงุชูุฑุฉ ุงูุดุฑุงุก:", error);
      toast({ 
        title: 'ุฎุทุฃ ูู ุงูุญุฐู', 
        description: `ูุดู ุญุฐู ุงููุงุชูุฑุฉ: ${error.message}`, 
        variant: 'destructive' 
      });
      return { success: false, error: error.message };
    } finally {
      setLoading(false);
    }
  }, [refetchData, user]);

  const updatePurchase = useCallback(async (purchaseId, updates) => {
    try {
      const { data, error } = await supabase
        .from('purchases')
        .update(updates)
        .eq('id', purchaseId)
        .select()
        .single();

      if (error) throw error;

      setPurchases(prev => prev.map(p => p.id === purchaseId ? data : p));
      toast({ title: 'ุชู', description: 'ุชู ุชุญุฏูุซ ูุงุชูุฑุฉ ุงูุดุฑุงุก ุจูุฌุงุญ' });
      
      return { success: true, purchase: data };
    } catch (error) {
      console.error("ุฎุทุฃ ูู ุชุญุฏูุซ ูุงุชูุฑุฉ ุงูุดุฑุงุก:", error);
      toast({ 
        title: 'ุฎุทุฃ', 
        description: 'ูุดู ุชุญุฏูุซ ูุงุชูุฑุฉ ุงูุดุฑุงุก', 
        variant: 'destructive' 
      });
      return { success: false };
    }
  }, []);

  return {
    purchases,
    setPurchases,
    loading,
    addPurchase,
    fetchPurchases,
    deletePurchase,
    updatePurchase,
  };
};